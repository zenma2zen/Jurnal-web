<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WHARSA - Bookmark Saya</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family:'Inter',sans-serif; background:#f7f8fc; margin:0; padding:20px; }
    h1 { color:#4361ee; margin:0 0 6px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    #profilePic { width:40px; height:40px; border-radius:50%; display:none; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    input { padding:10px 12px; border-radius:8px; border:1px solid #ddd; flex:1; min-width:200px; }
    button,a.btn { padding:8px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; text-decoration:none; color:#222; }
    button:hover,a.btn:hover { background:#e0e5ff; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:15px; }
    .card { background:#fff; padding:16px; border-radius:10px; border:1px solid #eee; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .title { font-weight:600; margin-bottom:6px; }
    .title a { color:#4361ee; text-decoration:none; }
    .url { font-size:13px; color:#666; margin-bottom:10px; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
    .chip { background:#e0e5ff; color:#4361ee; padding:3px 8px; border-radius:999px; font-size:12px; }
    .row { display:flex; gap:8px; }
    .empty { padding:30px; text-align:center; color:#999; }
    #loginContainer { text-align: center; margin: 30px 0; }
    .loading { color: #666; font-style: italic; }
    .error-box { 
      background: #ffebee; 
      color: #c62828; 
      padding: 12px; 
      border-radius: 8px; 
      margin: 15px 0; 
      display: none;
      border-left: 4px solid #c62828;
    }
    .success-box { 
      background: #e8f5e9; 
      color: #2e7d32; 
      padding: 12px; 
      border-radius: 8px; 
      margin: 15px 0; 
      display: none;
      border-left: 4px solid #2e7d32;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>üîñ Bookmark Saya</h1>
      <div id="hello" style="color:#666"></div>
    </div>
    <img id="profilePic" alt="profile">
  </div>

  <div id="errorBox" class="error-box"></div>
  <div id="successBox" class="success-box"></div>

  <!-- Konten hanya ditampilkan jika sudah login -->
  <div id="loginContainer">
    <h2>Login untuk Mengelola Bookmark</h2>
    <p>Anda perlu login dengan Google untuk menyimpan dan mengakses bookmark Anda.</p>
    <div id="googleSignIn"></div>
    <p class="loading" id="loadingText" style="display: none;">Memuat data...</p>
  </div>

  <div id="contentContainer" style="display: none;">
    <div class="controls">
      <input id="search" placeholder="Cari judul...">
      <input id="tagFilter" placeholder="Filter tag (pisahkan koma)">
      <button onclick="clearFilters()">Reset</button>
      <button onclick="syncFromDrive()">üîÑ Sinkron Sekarang</button>
      <a href="indeks.html" class="btn">‚Üê Kembali</a>
      <button id="signOutBtn" onclick="signOut()">Keluar</button>
    </div>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Belum ada bookmark.</div>
  </div>

<script>
  let currentUser = null;
  let userBookmarks = {};
  let gAccessToken = null;
  const DRIVE_FILE_NAME = "WHARSA_bookmarks.json";
  // Menggunakan Client ID yang Anda berikan
  const GOOGLE_CLIENT_ID = "1002562957398-ku4m61a2qdsspcqcaholbut3o7t3p9nd.apps.googleusercontent.com";

  // Inisialisasi Google Sign In
  window.onload = function() {
    // Cek apakah pengguna sudah login sebelumnya
    try {
      currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
      gAccessToken = localStorage.getItem("gAccessToken");
    } catch (e) {
      console.error("Error parsing stored data:", e);
      showError("Terjadi kesalahan saat memuat data pengguna.");
    }

    // Setup Google Identity Services
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse,
      scope: "https://www.googleapis.com/auth/drive.appdata"
    });
    
    if (currentUser && gAccessToken) {
      // Jika sudah login, tampilkan UI
      showUserInterface();
      // Coba sinkronisasi data
      syncFromDrive();
    } else {
      // Jika belum login, tampilkan tombol login
      document.getElementById("loginContainer").style.display = "block";
      document.getElementById("contentContainer").style.display = "none";
      
      google.accounts.id.renderButton(
        document.getElementById("googleSignIn"),
        { theme: "outline", size: "large", text: "continue_with" }
      );
    }
  };

  function showError(message) {
    const errorBox = document.getElementById("errorBox");
    errorBox.textContent = message;
    errorBox.style.display = "block";
    setTimeout(() => {
      errorBox.style.display = "none";
    }, 5000);
  }

  function showSuccess(message) {
    const successBox = document.getElementById("successBox");
    successBox.textContent = message;
    successBox.style.display = "block";
    setTimeout(() => {
      successBox.style.display = "none";
    }, 3000);
  }

  function handleCredentialResponse(response) {
    document.getElementById("loadingText").style.display = "block";
    
    const data = parseJwt(response.credential);
    currentUser = { name: data.name, email: data.email, picture: data.picture };
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
    
    // Minta token akses untuk Google Drive
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/drive.appdata',
      callback: async (tokenResponse) => {
        if (tokenResponse && tokenResponse.access_token) {
          gAccessToken = tokenResponse.access_token;
          localStorage.setItem("gAccessToken", gAccessToken);
          
          // Tampilkan UI pengguna
          showUserInterface();
          
          // Sinkronisasi data dari Drive
          await syncFromDrive();
        } else {
          showError("Gagal mendapatkan token akses. Silakan coba lagi.");
        }
        document.getElementById("loadingText").style.display = "none";
      },
      error_callback: (error) => {
        console.error("Error getting access token:", error);
        showError("Gagal mendapatkan akses ke Google Drive. Pastikan Anda memberikan izin yang diperlukan.");
        document.getElementById("loadingText").style.display = "none";
      }
    });
    
    tokenClient.requestAccessToken();
  }

  function showUserInterface() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("contentContainer").style.display = "block";
    document.getElementById("profilePic").src = currentUser.picture;
    document.getElementById("profilePic").style.display = "block";
    document.getElementById("hello").textContent = "Halo, " + currentUser.name;
  }

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      console.error("Error parsing JWT:", e);
      showError("Terjadi kesalahan dalam proses autentikasi.");
      return {};
    }
  }

  function signOut() {
    // Hapus data dari localStorage
    localStorage.removeItem('currentUser');
    localStorage.removeItem('gAccessToken');
    
    // Reset state aplikasi
    currentUser = null;
    gAccessToken = null;
    userBookmarks = {};
    
    // Redirect ke halaman logout Google
    google.accounts.id.disableAutoSelect();
    google.accounts.id.revoke(localStorage.getItem('currentUser')?.email, () => {
      console.log('Consent revoked');
    });
    
    // Tampilkan kembali tombol login
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("contentContainer").style.display = "none";
    document.getElementById("profilePic").style.display = "none";
    document.getElementById("hello").textContent = "";
    
    // Render ulang tombol login
    google.accounts.id.renderButton(
      document.getElementById("googleSignIn"),
      { theme: "outline", size: "large", text: "continue_with" }
    );
    
    showSuccess("Anda telah berhasil logout.");
  }

  async function syncFromDrive() {
    if (!gAccessToken) {
      showError("Silakan login dengan akun Google terlebih dahulu.");
      return;
    }
    
    try {
      // Cari file bookmark di Google Drive
      let res = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}' and 'appDataFolder' in parents&spaces=appDataFolder`,
        { headers: { Authorization: "Bearer " + gAccessToken }}
      );
      
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          throw new Error("AUTHLOST");
        }
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      
      let files = await res.json();
      if (files.files && files.files.length > 0) {
        // File ditemukan, ambil kontennya
        let fileId = files.files[0].id;
        let contentRes = await fetch(
          `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
          { headers: { Authorization: "Bearer " + gAccessToken }}
        );
        
        if (!contentRes.ok) throw new Error(`HTTP error! status: ${contentRes.status}`);
        
        userBookmarks = await contentRes.json();
        showSuccess("‚úÖ Sinkronisasi berhasil diperbarui dari Google Drive.");
      } else {
        // File tidak ditemukan, buat file baru
        userBookmarks = {};
        await saveToDrive();
        showSuccess("üìÇ File baru bookmark dibuat di Google Drive.");
      }
      render();
    } catch (err) {
      console.error("Sync error:", err);
      
      // Jika token expired, minta pengguna login ulang
      if (err.message.includes("AUTHLOST") || err.message.includes("401") || err.message.includes("403")) {
        showError("Sesi telah berakhir. Silakan login kembali.");
        signOut();
      } else {
        showError("‚ö†Ô∏è Gagal sinkronisasi. Pastikan Anda memiliki koneksi internet dan coba lagi.");
      }
    }
  }

  async function saveToDrive() {
    if (!gAccessToken) return;
    
    try {
      // Cek apakah file sudah ada
      let res = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}' and 'appDataFolder' in parents&spaces=appDataFolder`,
        { headers: { Authorization: "Bearer " + gAccessToken }}
      );
      
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      
      let files = await res.json();
      if (files.files && files.files.length > 0) {
        // Update file yang sudah ada
        let fileId = files.files[0].id;
        let updateRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
          method: "PATCH",
          headers: { 
            Authorization: "Bearer " + gAccessToken, 
            "Content-Type": "application/json" 
          },
          body: JSON.stringify(userBookmarks)
        });
        
        if (!updateRes.ok) throw new Error(`HTTP error! status: ${updateRes.status}`);
      } else {
        // Buat file baru
        const metadata = { 
          name: DRIVE_FILE_NAME, 
          parents: ["appDataFolder"],
          mimeType: "application/json"
        };
        
        const form = new FormData();
        form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        form.append("file", new Blob([JSON.stringify(userBookmarks)], { type: "application/json" }));
        
        let createRes = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
          method: "POST",
          headers: { Authorization: "Bearer " + gAccessToken },
          body: form
        });
        
        if (!createRes.ok) throw new Error(`HTTP error! status: ${createRes.status}`);
      }
    } catch (err) {
      console.error("Error saving to Drive:", err);
      showError("Gagal menyimpan ke Google Drive. Silakan coba lagi.");
      throw err;
    }
  }

  function remove(link) { 
    delete userBookmarks[link]; 
    saveToDrive(); 
    render(); 
  }
  
  function editTags(link) {
    const item = userBookmarks[link];
    const input = prompt("Ubah tag:", (item.tags||[]).join(", "));
    if (input === null) return;
    item.tags = input.split(",").map(t => t.trim()).filter(Boolean);
    userBookmarks[link] = item; 
    saveToDrive(); 
    render();
  }

  function matchesFilter(item, q, tagStr) {
    const okTitle = !q || (item.title || "").toLowerCase().includes(q);
    if (!okTitle) return false;
    if (!tagStr) return true;
    
    const need = tagStr.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
    const have = (item.tags || []).map(t => t.toLowerCase());
    return need.every(t => have.includes(t));
  }

  function render() {
    const list = document.getElementById("list");
    const empty = document.getElementById("empty");
    list.innerHTML = "";
    
    const q = document.getElementById("search").value.trim().toLowerCase();
    const tagStr = document.getElementById("tagFilter").value.trim().toLowerCase();
    const items = Object.values(userBookmarks).filter(it => matchesFilter(it, q, tagStr));
    
    if (items.length === 0) { 
      empty.style.display = "block"; 
      return; 
    }
    
    empty.style.display = "none";
    items.forEach(it => {
      const host = (() => { 
        try {
          return new URL(it.link).hostname.replace(/^www\./, '');
        } catch(e) {
          return it.link;
        }
      })();
      
      // Escape single quotes in URL untuk menghindari masalah sintaks JavaScript
      const escapedLink = it.link.replace(/'/g, "\\'");
      
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div>
          <div class="title"><a href="${it.link}" target="_blank">${it.title || 'Tanpa judul'}</a></div>
          <div class="url">${host}</div>
          <div class="tags">${(it.tags || []).map(t => '<span class="chip">#' + t + '</span>').join('')}</div>
        </div>
        <div class="row">
          <button onclick="editTags('${escapedLink}')">‚úèÔ∏è Edit Tag</button>
          <button onclick="remove('${escapedLink}')">üóëÔ∏è Hapus</button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  function clearFilters() { 
    document.getElementById("search").value = ""; 
    document.getElementById("tagFilter").value = ""; 
    render(); 
  }
  
  // Setup event listeners untuk pencarian
  document.getElementById("search").addEventListener("input", render);
  document.getElementById("tagFilter").addEventListener("input", render);
</script>
</body>
</html>
