<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WHARSA - Bookmark Saya</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family:'Inter',sans-serif; background:#f7f8fc; margin:0; padding:20px; }
    h1 { color:#4361ee; margin:0 0 6px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    #profilePic { width:40px; height:40px; border-radius:50%; display:none; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    input { padding:10px 12px; border-radius:8px; border:1px solid #ddd; flex:1; min-width:200px; }
    button,a.btn { padding:8px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; text-decoration:none; color:#222; }
    button:hover,a.btn:hover { background:#e0e5ff; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:15px; }
    .card { background:#fff; padding:16px; border-radius:10px; border:1px solid #eee; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .title { font-weight:600; margin-bottom:6px; }
    .title a { color:#4361ee; text-decoration:none; }
    .url { font-size:13px; color:#666; margin-bottom:10px; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
    .chip { background:#e0e5ff; color:#4361ee; padding:3px 8px; border-radius:999px; font-size:12px; }
    .row { display:flex; gap:8px; }
    .empty { padding:30px; text-align:center; color:#999; }
    #loginContainer { text-align: center; margin: 30px 0; }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>üîñ Bookmark Saya</h1>
      <div id="hello" style="color:#666"></div>
    </div>
    <img id="profilePic" alt="profile">
  </div>

  <div id="loginContainer">
    <div id="googleSignIn" class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-size="large"></div>
    <button id="signOutBtn" onclick="signOut()" style="display:none;">Keluar</button>
  </div>

  <div id="contentContainer" style="display: none;">
    <div class="controls">
      <input id="search" placeholder="Cari judul...">
      <input id="tagFilter" placeholder="Filter tag (pisahkan koma)">
      <button onclick="clearFilters()">Reset</button>
      <a href="indeks.html" class="btn">‚Üê Kembali</a>
    </div>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Belum ada bookmark.</div>
  </div>

<script>
  let currentUser = null;
  let userBookmarks = {};
  const GOOGLE_CLIENT_ID = "1002562957398-ku4m61a2qdsspcqcaholbut3o7t3p9nd.apps.googleusercontent.com";

  // Inisialisasi Google Sign In
  window.onload = function() {
    try {
      currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
    } catch (e) { console.error("Error parsing stored data:", e); }

    if (currentUser) {
      showUserInterface();
      loadBookmarks();
    }

    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse
    });

    google.accounts.id.renderButton(
      document.getElementById("googleSignIn"),
      { theme: "outline", size: "large" }
    );
  };

  function handleCredentialResponse(response) {
    const data = parseJwt(response.credential);
    currentUser = { name: data.name, email: data.email, picture: data.picture };
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
    showUserInterface();
    loadBookmarks();
  }

  function showUserInterface() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("contentContainer").style.display = "block";
    document.getElementById("profilePic").src = currentUser.picture;
    document.getElementById("profilePic").style.display = "block";
    document.getElementById("hello").textContent = "Halo, " + currentUser.name;
    document.getElementById("signOutBtn").style.display = "inline-block";
  }

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      console.error("Error parsing JWT:", e);
      return {};
    }
  }

  function signOut() {
    localStorage.removeItem('currentUser');
    currentUser = null;
    userBookmarks = {};
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("contentContainer").style.display = "none";
    document.getElementById("profilePic").style.display = "none";
    document.getElementById("hello").textContent = "";
    document.getElementById("signOutBtn").style.display = "none";
  }

  function loadBookmarks() {
    if (!currentUser) return;
    const key = `bookmarks_${currentUser.email}`;
    const saved = localStorage.getItem(key);
    userBookmarks = saved ? JSON.parse(saved) : {};
    render();
  }

  function saveBookmarks() {
    if (!currentUser) return;
    const key = `bookmarks_${currentUser.email}`;
    localStorage.setItem(key, JSON.stringify(userBookmarks));
  }

  function remove(link) { delete userBookmarks[link]; saveBookmarks(); render(); }

  function editTags(link) {
    const item = userBookmarks[link];
    const input = prompt("Ubah tag:", (item.tags||[]).join(", "));
    if (input === null) return;
    item.tags = input.split(",").map(t => t.trim()).filter(Boolean);
    userBookmarks[link] = item; saveBookmarks(); render();
  }

  function matchesFilter(item, q, tagStr) {
    const okTitle = !q || (item.title || "").toLowerCase().includes(q);
    if (!okTitle) return false;
    if (!tagStr) return true;

    const need = tagStr.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
    const have = (item.tags || []).map(t => t.toLowerCase());
    return need.every(t => have.includes(t));
  }

  function render() {
    const list = document.getElementById("list");
    const empty = document.getElementById("empty");
    list.innerHTML = "";

    const q = document.getElementById("search").value.trim().toLowerCase();
    const tagStr = document.getElementById("tagFilter").value.trim().toLowerCase();
    const items = Object.values(userBookmarks).filter(it => matchesFilter(it, q, tagStr));

    if (items.length === 0) { empty.style.display = "block"; return; }
    empty.style.display = "none";

    items.forEach(it => {
      const host = (() => { try { return new URL(it.link).hostname.replace(/^www\./, ''); } catch(e) { return it.link; } })();
      const escapedLink = it.link.replace(/'/g, "\\'");

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div>
          <div class="title"><a href="${it.link}" target="_blank">${it.title || 'Tanpa judul'}</a></div>
          <div class="url">${host}</div>
          <div class="tags">${(it.tags || []).map(t => '<span class="chip">#' + t + '</span>').join('')}</div>
        </div>
        <div class="row">
          <button onclick="editTags('${escapedLink}')">‚úèÔ∏è Edit Tag</button>
          <button onclick="remove('${escapedLink}')">üóëÔ∏è Hapus</button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  function clearFilters(){ document.getElementById("search").value=""; document.getElementById("tagFilter").value=""; render(); }
  document.getElementById("search").addEventListener("input", render);
  document.getElementById("tagFilter").addEventListener("input", render);
</script>
</body>
</html>
